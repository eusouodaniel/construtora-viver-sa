<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/src/ConstrutoraViverSA.Domain/Obra.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
#nullable enable
using ConstrutoraViverSA.Domain.Enums;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using ConstrutoraViverSA.Domain.Exceptions;

namespace ConstrutoraViverSA.Domain;

public sealed class Obra
{
    public long Id { get; }
    public string Nome { get; private set; }
    public string Endereco { get; private set; }
    public TipoObraEnum? TipoObra { get; private set; }
    public string Descricao { get; private set; }
    public double? Valor { get; private set; }
    public DateTime? PrazoConclusao { get; private set; }
    public Orcamento Orcamento { get; private set; }
    
    public long OrcamentoId;
    public ICollection&lt;Funcionario&gt;? Funcionarios { get; } = new Collection&lt;Funcionario&gt;();
    public ICollection&lt;ObraMaterial&gt;? ObraMateriais { get; } = new Collection&lt;ObraMaterial&gt;();

    [ExcludeFromCodeCoverage]
    public Obra()
    {
    }

    public Obra(string nome, string endereco, TipoObraEnum? tipoObra, string descricao,
        double? valor, DateTime? prazoConclusao, Orcamento? orcamento, List&lt;Funcionario&gt;? funcionarios,
        Dictionary&lt;Material, int&gt;? materiais)
    {
        var erros = new StringBuilder();

        if (string.IsNullOrWhiteSpace(nome))
            erros.Append(&quot;Nome inv&#225;lido.&quot;);

        if (string.IsNullOrWhiteSpace(endereco))
            erros.Append(&quot;Endere&#231;o inv&#225;lido.&quot;);

        if (tipoObra is null)
            erros.Append(&quot;Tipo Obra inv&#225;lido.&quot;);

        if (string.IsNullOrWhiteSpace(descricao))
            erros.Append(&quot;Descri&#231;&#227;o inv&#225;lida.&quot;);

        if (valor is null or &lt;= 0)
            erros.Append(&quot;Valor inv&#225;lido.&quot;);
        
        if (orcamento is null)
            erros.Append(&quot;Orcamento inv&#225;lido.&quot;);

        if (orcamento is not null)
        {
            if (prazoConclusao is null || prazoConclusao.Value &lt; orcamento!.DataValidade )
                erros.Append(&quot;Prazo conclus&#227;o inv&#225;lido.&quot;);
        }

        if (erros.Length &gt; 0)
            throw new ObraInvalidaException(erros.ToString());

        Nome = nome;
        Endereco = endereco;
        TipoObra = tipoObra;
        Descricao = descricao;
        Valor = valor;
        PrazoConclusao = prazoConclusao;
        Orcamento = orcamento!;

        if (funcionarios is not null &amp;&amp; funcionarios.Count is &gt; 0)
        {
            foreach (var funcionario in funcionarios)
            {
                Funcionarios.Add(funcionario);
            }
        }

        if (materiais is not null &amp;&amp; materiais.Count is &gt; 0)
        {
            foreach (var material in materiais)
            {
                ObraMateriais!.Add(new ObraMaterial(this, material.Key, material.Value, EntradaSaidaEnum.Entrada));
            }
        }
    }

    public void SetNome(string nome)
    {
        if (string.IsNullOrWhiteSpace(nome))
            return;

        Nome = nome;
    }

    public void SetEndereco(string endereco)
    {
        if (string.IsNullOrWhiteSpace(endereco))
            return;

        Endereco = endereco;
    }

    public void SetTipoObra(TipoObraEnum? tipoObra)
    {
        if (tipoObra is null)
            return;

        TipoObra = tipoObra.Value;
    }

    public void SetDescricao(string descricao)
    {
        if (string.IsNullOrWhiteSpace(descricao))
            return;

        Descricao = descricao;
    }

    public void SetValor(double? valor)
    {
        if (valor is null or &lt;= 0)
            return;

        Valor = valor.Value;
    }

    public void SetPrazoConclusao(DateTime? prazoConclusao)
    {
        if (prazoConclusao is null || prazoConclusao.Value &lt; Orcamento.DataValidade)
            return;

        PrazoConclusao = prazoConclusao;
    }

    public void SetOrcamento(Orcamento? orcamento)
    {
        if (orcamento is null)
            return;

        Orcamento = orcamento;
    }

    public void AlocarFuncionario(Funcionario funcionario)
    {
        if (Funcionarios.Contains(funcionario))
            throw new OperacaoInvalidaException(
                $&quot;Funcion&#225;rio {funcionario.Nome} j&#225; est&#225; alocado na obra {this.Nome}&quot;);
        
        Funcionarios.Add(funcionario);
    }

    public void DesalocarFuncionario(Funcionario funcionario)
    {
        if (!Funcionarios.Contains(funcionario))
            throw new OperacaoInvalidaException($&quot;Funcion&#225;rio {funcionario.Nome} n&#227;o est&#225; alocado na obra {this.Nome}&quot;);
        
        Funcionarios.Remove(funcionario);
    }

    public void AlocarMaterial(Material material, int? quantidade)
    {
        if (material.Quantidade &lt; quantidade)
            throw new OperacaoInvalidaException(
                $&quot;N&#227;o h&#225; itens suficientes em estoque do material {material.Nome} para alocar na obra {this.Nome}&quot;);
        
        ObraMateriais.Add(new ObraMaterial(this, material, quantidade, EntradaSaidaEnum.Entrada));
    }

    public void DesalocarMaterial(Material material, int? quantidade)
    {
        if (quantidade is null or &lt;= 0)
            throw new OperacaoInvalidaException(&quot;Quantidade inv&#225;lida&quot;);
        
        var entrada = ObraMateriais.Where(x =&gt; x.Operacao == EntradaSaidaEnum.Entrada &amp;&amp; x.MaterialId == material.Id).Sum(x =&gt; x.Quantidade);
        var saida = ObraMateriais.Where(x =&gt; x.Operacao == EntradaSaidaEnum.Saida &amp;&amp; x.MaterialId == material.Id).Sum(x =&gt; x.Quantidade);

        var saldoDeMateriaisNaObra = entrada - saida;
        
        if (saldoDeMateriaisNaObra &lt;= 0)
            throw new OperacaoInvalidaException(
                $&quot;Material {material.Nome} n&#227;o est&#225; alocado na obra {this.Nome}&quot;);

        if (quantidade &gt; saldoDeMateriaisNaObra)
            throw new OperacaoInvalidaException(
                $&quot;Material {material.Nome} est&#225; alocado na obra {this.Nome} com apenas {saldoDeMateriaisNaObra} itens&quot;);

        ObraMateriais.Add(new ObraMaterial(this, material, quantidade, EntradaSaidaEnum.Saida));
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,22,15,26,1],[16,26,16,30,1],[16,31,16,43,1],[17,30,17,34,1],[17,35,17,47,1],[18,37,18,41,1],[18,42,18,54,1],[19,31,19,35,1],[19,36,19,48,1],[20,28,20,32,1],[20,33,20,45,1],[21,39,21,43,1],[21,44,21,56,1],[22,34,22,38,1],[22,39,22,51,1],[25,53,25,57,1],[25,62,25,91,1],[25,62,25,91,1],[26,55,26,59,1],[26,64,26,94,1],[26,64,26,94,1],[29,5,29,18,1],[30,5,30,6,1],[31,5,31,6,1],[33,5,35,46,1],[36,5,36,6,1],[37,9,37,41,1],[39,9,39,45,1],[40,13,40,44,1],[42,9,42,49,1],[43,13,43,48,1],[45,9,45,30,1],[46,13,46,49,1],[48,9,48,50,1],[49,13,49,49,1],[51,9,51,35,1],[52,13,52,45,1],[54,9,54,31,1],[55,13,55,49,1],[57,9,57,35,1],[58,9,58,10,1],[59,13,59,91,1],[60,17,60,59,1],[61,9,61,10,1],[63,9,63,30,1],[64,13,64,63,1],[66,9,66,21,1],[67,9,67,29,1],[68,9,68,29,1],[69,9,69,31,1],[70,9,70,23,1],[71,9,71,41,1],[72,9,72,32,1],[74,9,74,67,1],[75,9,75,10,1],[76,13,76,20,1],[76,22,76,37,1],[76,38,76,40,1],[76,41,76,53,1],[77,13,77,14,1],[78,17,78,47,1],[79,13,79,14,1],[80,9,80,10,1],[82,9,82,61,1],[83,9,83,10,1],[84,13,84,20,1],[84,22,84,34,1],[84,35,84,37,1],[84,38,84,47,1],[85,13,85,14,1],[86,17,86,116,1],[87,13,87,14,1],[88,9,88,10,1],[89,5,89,6,1],[92,5,92,6,1],[93,9,93,45,1],[94,13,94,20,1],[96,9,96,21,1],[97,5,97,6,1],[100,5,100,6,1],[101,9,101,49,1],[102,13,102,20,1],[104,9,104,29,1],[105,5,105,6,1],[108,5,108,6,1],[109,9,109,30,1],[110,13,110,20,1],[112,9,112,35,1],[113,5,113,6,1],[116,5,116,6,1],[117,9,117,50,1],[118,13,118,20,1],[120,9,120,31,1],[121,5,121,6,1],[124,5,124,6,1],[125,9,125,35,1],[126,13,126,20,1],[128,9,128,29,1],[129,5,129,6,1],[132,5,132,6,1],[133,9,133,85,1],[134,13,134,20,1],[136,9,136,41,1],[137,5,137,6,1],[140,5,140,6,1],[141,9,141,31,1],[142,13,142,20,1],[144,9,144,31,1],[145,5,145,6,1],[148,5,148,6,1],[149,9,149,48,1],[150,13,151,88,1],[153,9,153,39,1],[154,5,154,6,1],[157,5,157,6,1],[158,9,158,49,1],[159,13,159,121,1],[161,9,161,42,1],[162,5,162,6,1],[165,5,165,6,1],[166,9,166,46,1],[167,13,168,117,1],[170,9,170,99,1],[171,5,171,6,1],[174,5,174,6,1],[175,9,175,40,1],[176,13,176,72,1],[178,9,178,48,1],[178,48,178,117,1],[178,117,178,128,1],[178,128,178,140,1],[178,140,178,142,1],[179,9,179,46,1],[179,46,179,113,1],[179,113,179,124,1],[179,124,179,136,0],[179,136,179,138,1],[181,9,181,54,1],[183,9,183,41,1],[184,13,185,83,1],[187,9,187,49,1],[188,13,189,121,1],[191,9,191,97,1],[192,5,192,6,1]]);
    </script>
  </body>
</html>