<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/tests/ConstrutoraViverSA.Api.Tests/Controllers/OrcamentoControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using AutoFixture;
using AutoMapper;
using ConstrutoraViverSA.Api.Controllers;
using ConstrutoraViverSA.Api.Controllers.Requests;
using ConstrutoraViverSA.Application.Interfaces;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Exceptions;
using FluentAssertions;
using Moq;
using Xunit;

namespace ConstrutoraViverSA.Api.Tests.Controllers;

public class OrcamentoControllerTests
{
    private readonly Mock&lt;IOrcamentoService&gt; _orcamentoServiceMock;
    private readonly Mock&lt;IMapper&gt; _mapperMock;
    private readonly OrcamentoController _controller;
    private readonly Fixture _fixture = new Fixture();

    public OrcamentoControllerTests()
    {
        _orcamentoServiceMock = new Mock&lt;IOrcamentoService&gt;();
        _mapperMock = new Mock&lt;IMapper&gt;();
        _controller = new OrcamentoController(_orcamentoServiceMock.Object, _mapperMock.Object);
    }

    [Fact]
    public void CadastrarOrcamento_ComDadosValidos_DeveRealizarOperacao()
    {
        var request = _fixture.Build&lt;OrcamentoRequest&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(1))
            .Create();
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;OrcamentoRequest&gt;(x =&gt; x == request))).Returns(dto);
        _orcamentoServiceMock.Setup(x =&gt; x.Adicionar(It.Is&lt;OrcamentoDto&gt;(x =&gt; x == dto)));

        var resultado = _controller.CadastrarOrcamento(request);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _orcamentoServiceMock.Verify(X =&gt; X.Adicionar(It.Is&lt;OrcamentoDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;OrcamentoRequest&gt;(x =&gt; x == request)), Times.Once);
    }
    
    [Fact]
    public void CadastrarOrcamento_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var request = _fixture.Build&lt;OrcamentoRequest&gt;()
            .Without(x =&gt; x.Valor)
            .Create();
     
        var resultado = () =&gt; _controller.CadastrarOrcamento(request);
        
        resultado.Should().Throw&lt;ErroValidacaoException&gt;();
       }

    [Fact]
    public void BuscarOrcamento_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var orcamento = _fixture.Create&lt;OrcamentoDto&gt;();
        _orcamentoServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId))).Returns(orcamento);

        var resultado = _controller.BuscarOrcamento(orcamentoId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.First().Should().BeOfType&lt;OrcamentoDto&gt;();
        resultado.Dados.First().Should().BeEquivalentTo(orcamento);
        _orcamentoServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }
    
    [Fact]
    public void BuscarOrcamento_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _orcamentoServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Throws(new NaoEncontradoException(&quot;Orcamento n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.BuscarOrcamento(orcamentoId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _orcamentoServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }

    [Fact]
    public void BuscarOrcamentos_ComDadosValidos_DeveRealizarOperacao()
    {
        var listaOrcamentos = _fixture.CreateMany&lt;OrcamentoDto&gt;().ToList();
        _orcamentoServiceMock.Setup(x =&gt; x.BuscarTodos())
            .Returns(listaOrcamentos);

        var resultado = _controller.BuscarOrcamentos();

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.Count.Should().Be(listaOrcamentos.Count);
        resultado.Dados.ForEach(x =&gt; x.Should().BeOfType&lt;OrcamentoDto&gt;());
        for (var i =0; i&lt; listaOrcamentos.Count; i++)
        {
            resultado.Dados[i].Should().BeEquivalentTo(listaOrcamentos[i]);
        }
        _orcamentoServiceMock.Verify(x =&gt; x.BuscarTodos(), Times.Once);
    }

    [Fact]
    public void EditarOrcamento_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var request = _fixture.Build&lt;OrcamentoRequest&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(1))
            .Create();
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;OrcamentoRequest&gt;(x =&gt; x == request))).Returns(dto);
        _orcamentoServiceMock.Setup(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == orcamentoId),It.Is&lt;OrcamentoDto&gt;(x =&gt; x == dto)));

        var resultado = _controller.EditarOrcamento(request, orcamentoId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _orcamentoServiceMock.Verify(X =&gt; X.Editar(It.Is&lt;long&gt;(x =&gt; x == orcamentoId),It.Is&lt;OrcamentoDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;OrcamentoRequest&gt;(x =&gt; x == request)), Times.Once);
    }

    [Fact]
    public void EditarOrcamento_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var request = _fixture.Build&lt;OrcamentoRequest&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(1))
            .Create();
        _orcamentoServiceMock.Setup(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == orcamentoId), It.IsAny&lt;OrcamentoDto&gt;()))
            .Throws(new NaoEncontradoException(&quot;Orcamento n&#227;o encontrado&quot;));
        
        var resultado = () =&gt; _controller.EditarOrcamento(request, orcamentoId);
        
        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _orcamentoServiceMock.Verify(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == orcamentoId), It.IsAny&lt;OrcamentoDto&gt;()), Times.Once);
    }

    [Fact]
    public void ExcluirOrcamento_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _orcamentoServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)));

        var resultado = _controller.ExcluirOrcamento(orcamentoId);
        
        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _orcamentoServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }
    
    [Fact]
    public void ExcluirOrcamento_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _orcamentoServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Throws(new NaoEncontradoException(&quot;Orcamento n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.ExcluirOrcamento(orcamentoId);
        
        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _orcamentoServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,5,21,55,1],[23,5,23,38,1],[24,5,24,6,1],[25,9,25,63,1],[26,9,26,43,1],[27,9,27,97,1],[28,5,28,6,1],[32,5,32,6,1],[33,9,36,23,1],[37,9,38,23,1],[39,9,39,110,1],[40,9,40,91,1],[42,9,42,65,1],[44,9,44,45,1],[45,9,45,43,1],[46,9,46,47,1],[47,9,47,104,1],[48,9,48,110,1],[49,5,49,6,1],[53,5,53,6,1],[54,9,56,23,1],[58,9,58,31,1],[58,31,58,70,1],[58,70,58,71,1],[60,9,60,60,1],[61,8,61,9,1],[65,5,65,6,1],[66,9,66,29,1],[67,9,67,57,1],[68,9,68,112,1],[70,9,70,66,1],[72,9,72,45,1],[73,9,73,47,1],[74,9,74,46,1],[75,9,75,67,1],[76,9,76,68,1],[77,9,77,106,1],[78,5,78,6,1],[82,5,82,6,1],[83,9,83,29,1],[84,9,85,77,1],[87,9,87,31,1],[87,31,87,71,1],[87,71,87,72,1],[89,9,89,60,1],[90,9,90,106,1],[91,5,91,6,1],[95,5,95,6,1],[96,9,96,76,1],[97,9,98,39,1],[100,9,100,56,1],[102,9,102,45,1],[103,9,103,47,1],[104,9,104,46,1],[105,9,105,66,1],[106,9,106,38,1],[106,38,106,73,1],[106,73,106,75,1],[107,14,107,22,1],[107,24,107,48,1],[107,50,107,53,1],[108,9,108,10,1],[109,13,109,76,1],[110,9,110,10,1],[111,9,111,72,1],[112,5,112,6,1],[116,5,116,6,1],[117,9,117,29,1],[118,9,121,23,1],[122,9,123,23,1],[124,9,124,110,1],[125,9,125,123,1],[127,9,127,75,1],[129,9,129,45,1],[130,9,130,43,1],[131,9,131,47,1],[132,9,132,136,1],[133,9,133,110,1],[134,5,134,6,1],[138,5,138,6,1],[139,9,139,29,1],[140,9,143,23,1],[144,9,145,77,1],[147,9,147,31,1],[147,31,147,80,1],[147,80,147,81,1],[149,9,149,60,1],[150,9,150,127,1],[151,5,151,6,1],[155,5,155,6,1],[156,9,156,29,1],[157,9,157,89,1],[159,9,159,67,1],[161,9,161,45,1],[162,9,162,43,1],[163,9,163,47,1],[164,9,164,102,1],[165,5,165,6,1],[169,5,169,6,1],[170,9,170,29,1],[171,9,172,77,1],[174,9,174,31,1],[174,31,174,72,1],[174,72,174,73,1],[176,9,176,60,1],[177,9,177,102,1],[178,5,178,6,1]]);
    </script>
  </body>
</html>