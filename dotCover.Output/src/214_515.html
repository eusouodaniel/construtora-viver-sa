<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/tests/ConstrutoraViverSA.Application.Tests/Services/OrcamentoServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using AutoFixture;
using AutoMapper;
using ConstrutoraViverSA.Application.Services;
using ConstrutoraViverSA.Domain;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Exceptions;
using ConstrutoraViverSA.Repository.Interfaces;
using FluentAssertions;
using Moq;
using Xunit;

namespace ConstrutoraViverSA.Application.Tests.Services;

public class OrcamentoServiceTests
{
    private readonly Mock&lt;IOrcamentoRepository&gt; _repositoryMock;
    private readonly Mock&lt;IMapper&gt; _mapperMock;
    private readonly Fixture _fixture = new Fixture();
    private readonly OrcamentoService _service; 

    public OrcamentoServiceTests()
    {
        _repositoryMock = new Mock&lt;IOrcamentoRepository&gt;();
        _mapperMock = new Mock&lt;IMapper&gt;();
        _service = new OrcamentoService(_repositoryMock.Object, _mapperMock.Object);
    }

    [Fact]
    public void BuscarTodos_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentos = _fixture.CreateMany&lt;Orcamento&gt;().ToList();
        var orcamentosDto = _fixture.CreateMany&lt;OrcamentoDto&gt;(3).ToList();
        _repositoryMock.Setup(x =&gt; x.BuscarTodos()).Returns(orcamentos);
        _mapperMock.SetupSequence(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.IsAny&lt;Orcamento&gt;()))
            .Returns(orcamentosDto[0])
            .Returns(orcamentosDto[1])
            .Returns(orcamentosDto[2]);

        var resultado = _service.BuscarTodos();

        resultado.Count.Should().Be(orcamentos.Count);
        resultado.Should().BeEquivalentTo(orcamentosDto);
        _repositoryMock.Verify(x =&gt; x.BuscarTodos(), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.IsAny&lt;Orcamento&gt;()), Times.Exactly(3));
    }

    [Fact]
    public void BuscarEntidadePorId_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var orcamento = _fixture.Build&lt;Orcamento&gt;()
            .With(x =&gt; x.Id, orcamentoId)
            .Create();
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Returns(orcamento);

        var resultado = _service.BuscarEntidadePorId(orcamentoId);

        resultado.Should().NotBeNull();
        resultado.Should().BeOfType&lt;Orcamento&gt;();
        resultado.Should().BeEquivalentTo(orcamento);
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }
    
    [Fact]
    public void BuscarEntidadePorId_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Returns((Orcamento)null);

        var resultado = () =&gt; _service.BuscarEntidadePorId(orcamentoId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }
    
    [Fact]
    public void BuscarPorId_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var orcamento = _fixture.Build&lt;Orcamento&gt;()
            .With(x =&gt; x.Id, orcamentoId)
            .Create();
        var orcamentoDto = _fixture.Create&lt;OrcamentoDto&gt;();
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Returns(orcamento);
        _mapperMock.Setup(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;Orcamento&gt;(x =&gt; x == orcamento)))
            .Returns(orcamentoDto);

        var resultado = _service.BuscarPorId(orcamentoId);

        resultado.Should().NotBeNull();
        resultado.Should().BeOfType&lt;OrcamentoDto&gt;();
        resultado.Should().BeEquivalentTo(orcamentoDto);
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;OrcamentoDto&gt;(It.Is&lt;Orcamento&gt;(x =&gt; x == orcamento)), Times.Once);
    }
    
    [Fact]
    public void BuscarPorId_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Returns((Orcamento)null);

        var resultado = () =&gt; _service.BuscarPorId(orcamentoId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
    }

    [Fact]
    public void Adicionar_ComDadosValidos_DeveRealizarOperacao()
    {
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(1))
            .Create();
        _repositoryMock.Setup(x =&gt; x.Adicionar(It.IsAny&lt;Orcamento&gt;()));

        var resultado = () =&gt; _service.Adicionar(dto);

        resultado.Should().NotThrow&lt;OrcamentoInvalidoException&gt;();
        _repositoryMock.Verify(x =&gt; x.Adicionar(It.IsAny&lt;Orcamento&gt;()), Times.Once);
    }
    
    [Fact]
    public void Adicionar_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(-1))
            .Create();

        var resultado = () =&gt; _service.Adicionar(dto);

        resultado.Should().Throw&lt;OrcamentoInvalidoException&gt;();
    }
    
    [Fact]
    public void Editar_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(1))
            .Create();
        var orcamento = _fixture.Build&lt;Orcamento&gt;()
            .With(x =&gt; x.Id, orcamentoId)
            .Create();
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId))).Returns(orcamento);
        _repositoryMock.Setup(x =&gt; x.Editar(It.IsAny&lt;Orcamento&gt;()));

        var resultado = () =&gt; _service.Editar(orcamentoId, dto);

        resultado.Should().NotThrow&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
        _repositoryMock.Verify(x =&gt; x.Editar(It.IsAny&lt;Orcamento&gt;()), Times.Once);
    }
    
    [Fact]
    public void Editar_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var dto = _fixture.Build&lt;OrcamentoDto&gt;()
            .With(x =&gt; x.DataEmissao, DateTime.Today)
            .With(x =&gt; x.DataValidade, DateTime.Today.AddDays(-1))
            .Create();
        var orcamento = _fixture.Build&lt;Orcamento&gt;()
            .With(x =&gt; x.Id, orcamentoId)
            .Create();
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId))).Returns(orcamento);
        _repositoryMock.Setup(x =&gt; x.Editar(It.IsAny&lt;Orcamento&gt;()));

        var resultado = () =&gt; _service.Editar(orcamentoId, dto);
        
        resultado.Should().NotThrow&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
        _repositoryMock.Verify(x =&gt; x.Editar(It.IsAny&lt;Orcamento&gt;()), Times.Once); 
    }
    
    [Fact]
    public void Excluir_ComDadosValidos_DeveRealizarOperacao()
    {
        var orcamentoId = 1;
        var orcamento = _fixture.Build&lt;Orcamento&gt;()
            .With(x =&gt; x.Id, orcamentoId)
            .Create();
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId))).Returns(orcamento);
        _repositoryMock.Setup(x =&gt; x.Excluir(It.Is&lt;Orcamento&gt;(x =&gt; x == orcamento)));

        var resultado = () =&gt; _service.Excluir(orcamentoId);

        resultado.Should().NotThrow&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
        _repositoryMock.Verify(x =&gt; x.Excluir(It.Is&lt;Orcamento&gt;(x =&gt; x == orcamento)), Times.Once);
    }
    
    [Fact]
    public void Excluir_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var orcamentoId = 1;
        _repositoryMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)))
            .Returns((Orcamento)null);

        var resultado = () =&gt; _service.Excluir(orcamentoId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _repositoryMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == orcamentoId)), Times.Once);
        _repositoryMock.Verify(x =&gt; x.Excluir(It.IsAny&lt;Orcamento&gt;()), Times.Never);
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,5,20,55,1],[23,5,23,35,1],[24,5,24,6,1],[25,9,25,60,1],[26,9,26,43,1],[27,9,27,85,1],[28,5,28,6,1],[32,5,32,6,1],[33,9,33,68,1],[34,9,34,75,1],[35,9,35,73,1],[36,9,39,40,1],[41,9,41,48,1],[43,9,43,55,1],[44,9,44,58,1],[45,9,45,66,1],[46,9,46,95,1],[47,5,47,6,1],[51,5,51,6,1],[52,9,52,29,1],[53,9,55,23,1],[56,9,57,33,1],[59,9,59,67,1],[61,9,61,40,1],[62,9,62,50,1],[63,9,63,54,1],[64,9,64,100,1],[65,5,65,6,1],[69,5,69,6,1],[70,9,70,29,1],[71,9,72,39,1],[74,9,74,31,1],[74,31,74,72,1],[74,72,74,73,1],[76,9,76,60,1],[77,9,77,100,1],[78,5,78,6,1],[82,5,82,6,1],[83,9,83,29,1],[84,9,86,23,1],[87,9,87,60,1],[88,9,89,33,1],[90,9,91,36,1],[93,9,93,59,1],[95,9,95,40,1],[96,9,96,53,1],[97,9,97,57,1],[98,9,98,100,1],[99,9,99,105,1],[100,5,100,6,1],[104,5,104,6,1],[105,9,105,29,1],[106,9,107,39,1],[109,9,109,31,1],[109,31,109,64,1],[109,64,109,65,1],[111,9,111,60,1],[112,9,112,100,1],[113,5,113,6,1],[117,5,117,6,1],[118,9,121,23,1],[122,9,122,72,1],[124,9,124,31,1],[124,31,124,54,1],[124,54,124,55,1],[126,9,126,67,1],[127,9,127,85,1],[128,5,128,6,1],[132,5,132,6,1],[133,9,136,23,1],[138,9,138,31,1],[138,31,138,54,1],[138,54,138,55,1],[140,9,140,64,1],[141,5,141,6,1],[145,5,145,6,1],[146,9,146,29,1],[147,9,150,23,1],[151,9,153,23,1],[154,9,154,106,1],[155,9,155,69,1],[157,9,157,31,1],[157,31,157,64,1],[157,64,157,65,1],[159,9,159,63,1],[160,9,160,100,1],[161,9,161,82,1],[162,5,162,6,1],[166,5,166,6,1],[167,9,167,29,1],[168,9,171,23,1],[172,9,174,23,1],[175,9,175,106,1],[176,9,176,69,1],[178,9,178,31,1],[178,31,178,64,1],[178,64,178,65,1],[180,9,180,63,1],[181,9,181,100,1],[182,9,182,82,1],[183,5,183,6,1],[187,5,187,6,1],[188,9,188,29,1],[189,9,191,23,1],[192,9,192,106,1],[193,9,193,86,1],[195,9,195,31,1],[195,31,195,60,1],[195,60,195,61,1],[197,9,197,63,1],[198,9,198,100,1],[199,9,199,99,1],[200,5,200,6,1],[204,5,204,6,1],[205,9,205,29,1],[206,9,207,39,1],[209,9,209,31,1],[209,31,209,60,1],[209,60,209,61,1],[211,9,211,60,1],[212,9,212,100,1],[213,9,213,84,1],[214,5,214,6,1]]);
    </script>
  </body>
</html>