<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/src/ConstrutoraViverSA.Application/Services/ObraService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using AutoMapper;
using ConstrutoraViverSA.Application.Interfaces;
using ConstrutoraViverSA.Domain;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Enums;
using ConstrutoraViverSA.Domain.Exceptions;
using ConstrutoraViverSA.Repository.Interfaces;
using Microsoft.EntityFrameworkCore.Query.SqlExpressions;

namespace ConstrutoraViverSA.Application.Services;

public class ObraService : IObraService
{
    private readonly IFuncionarioService _funcionarioService;
    private readonly IMaterialService _materialService;
    private readonly IOrcamentoService _orcamentoService;
    private readonly IObraRepository _repository;
    private readonly IMapper _mapper;
    private readonly IObraParaObraDto _obraParaObraDto;

    public ObraService(
        IObraRepository repository,
        IOrcamentoService orcamentoService,
        IFuncionarioService funcionarioService,
        IMaterialService materialService,
        IMapper mapper,
        IObraParaObraDto obraParaObraDto)
    {
        _repository = repository;
        _orcamentoService = orcamentoService;
        _funcionarioService = funcionarioService;
        _materialService = materialService;
        _mapper = mapper;
        _obraParaObraDto = obraParaObraDto;
    }

    public List&lt;ObraDto&gt; BuscarTodos()
    {
        var obras= _repository.BuscarTodos();

        var listaObrasDto = new List&lt;ObraDto&gt;();

        obras.ForEach(x =&gt; listaObrasDto.Add(_obraParaObraDto.Mapear(x)));

        return listaObrasDto;
    }

    public ObraDto BuscarPorId(long buscaId)
    {
        var obra = BuscarEntidadePorId(buscaId);

        return _obraParaObraDto.Mapear(obra);
    }
    
    public Obra BuscarEntidadePorId(long buscaId)
    {
        var obra = _repository.BuscarPorId(buscaId);

        if (obra is null) throw new NaoEncontradoException(&quot;Obra n&#227;o encontrada&quot;);

        return obra;
    }

    public void Adicionar(ObraDto dto)
    {
        var orcamento = _orcamentoService.BuscarEntidadePorId((long)dto.OrcamentoId);
        
        var funcionarios = (dto.Funcionarios is not null) ? BuscarListaDeFuncionarios(dto.Funcionarios) : null;

        var materiais = (dto.Materiais is not null) ? BuscarDicionarioDeMateriaisEQuantidades(dto.Materiais) : null;
        
        var obra = new Obra(dto.Nome, dto.Endereco, dto.TipoObra, dto.Descricao, dto.Valor, dto.PrazoConclusao,
            orcamento, funcionarios, materiais);

        _repository.Adicionar(obra);
    }

    private List&lt;Funcionario&gt; BuscarListaDeFuncionarios(List&lt;long&gt; funcionariosId)
    {
        var funcionarios = new List&lt;Funcionario&gt;();

        foreach (var funcionarioId in funcionariosId)
        {
            funcionarios.Add(_funcionarioService.BuscarEntidadePorId(funcionarioId));
        }

        return funcionarios;
    }

    private Dictionary&lt;Material, int&gt; BuscarDicionarioDeMateriaisEQuantidades(Dictionary&lt;long, int&gt; dicionarioDeMateriais)
    {
        var materiais = new Dictionary&lt;Material, int&gt;();

        foreach (var material in dicionarioDeMateriais)
        {
            materiais.Add(_materialService.BuscarEntidadePorId(material.Key), material.Value);
        }

        return materiais;
    }

    public void Excluir(long idExcluir)
    {
        var obra = BuscarEntidadePorId(idExcluir);

        _repository.Excluir(obra);
    }

    public void Editar(long id, ObraDto obralAtualizado)
    {
        if (obralAtualizado.Funcionarios != null &amp;&amp; obralAtualizado.Funcionarios.Count &gt; 0)
            throw new OperacaoInvalidaException(&quot;Funcionarios n&#227;o podem ser alterados na edi&#231;&#227;o&quot;);
        
        if (obralAtualizado.Materiais != null &amp;&amp; obralAtualizado.Materiais.Count &gt; 0)
            throw new OperacaoInvalidaException(&quot;Materiais n&#227;o podem ser alterados na edi&#231;&#227;o&quot;);

        var obra = BuscarEntidadePorId(id);

        if (obralAtualizado.OrcamentoId != null &amp;&amp; obralAtualizado.OrcamentoId != obra.OrcamentoId)
        {
            var orcamento = _orcamentoService.BuscarEntidadePorId((long)obralAtualizado.OrcamentoId);
            obra.SetOrcamento(orcamento);
        }

        obra.SetNome(obralAtualizado.Nome);
        obra.SetDescricao(obralAtualizado.Descricao);
        obra.SetEndereco(obralAtualizado.Endereco);
        obra.SetTipoObra(obralAtualizado.TipoObra);
        obra.SetValor(obralAtualizado.Valor);
        obra.SetPrazoConclusao(obralAtualizado.PrazoConclusao);

        _repository.Editar(obra);
    }

    public void GerenciarMaterial(EntradaSaidaMaterialDto materialDto, long id, long materialId)
    {
        if (materialDto.Operacao == EntradaSaidaEnum.Entrada)
            AlocarMaterial(materialDto, id, materialId);
        else
            DesalocarMaterial(materialDto, id, materialId);
    }
    
    private void AlocarMaterial(EntradaSaidaMaterialDto materialDto, long id, long materialId)
    {
        var material = _materialService.BuscarEntidadePorId(materialId);

        var obra = BuscarEntidadePorId(id);

        obra.AlocarMaterial(material, materialDto.Quantidade);

        _repository.Editar(obra);
    }

    private void DesalocarMaterial(EntradaSaidaMaterialDto materialDto, long id, long materialId)
    {
        var material = _materialService.BuscarEntidadePorId(materialId);

        var obra = BuscarEntidadePorId(id);
        
        obra.DesalocarMaterial(material, materialDto.Quantidade);

        _repository.Editar(obra);
    }

    public void AlocarFuncionario(long id, long funcionarioId)
    {
        var funcionario = _funcionarioService.BuscarEntidadePorId(funcionarioId);

        var obra = BuscarEntidadePorId(id);

        obra.AlocarFuncionario(funcionario);

        _repository.Editar(obra);
    }

    public void DesalocarFuncionario(long id, long funcionarioId)
    {
        var funcionario = _funcionarioService.BuscarEntidadePorId(funcionarioId);

        var obra = BuscarEntidadePorId(id);

        obra.DesalocarFuncionario(funcionario);

        _repository.Editar(obra);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,5,29,42,1],[30,5,30,6,1],[31,9,31,34,1],[32,9,32,46,1],[33,9,33,50,1],[34,9,34,44,1],[35,9,35,26,1],[36,9,36,44,1],[37,5,37,6,1],[40,5,40,6,1],[41,9,41,46,1],[43,9,43,49,1],[45,9,45,28,1],[45,28,45,73,1],[45,73,45,75,1],[47,9,47,30,1],[48,5,48,6,1],[51,5,51,6,1],[52,9,52,49,1],[54,9,54,46,1],[55,5,55,6,1],[58,5,58,6,1],[59,9,59,53,1],[61,9,61,26,1],[61,27,61,83,1],[63,9,63,21,1],[64,5,64,6,1],[67,5,67,6,1],[68,9,68,86,1],[70,9,70,112,1],[72,9,72,117,1],[74,9,75,49,1],[77,9,77,37,1],[78,5,78,6,1],[81,5,81,6,1],[82,9,82,52,1],[84,9,84,16,1],[84,18,84,35,1],[84,36,84,38,1],[84,39,84,53,1],[85,9,85,10,1],[86,13,86,86,1],[87,9,87,10,1],[89,9,89,29,1],[90,5,90,6,1],[93,5,93,6,1],[94,9,94,57,1],[96,9,96,16,1],[96,18,96,30,1],[96,31,96,33,1],[96,34,96,55,1],[97,9,97,10,1],[98,13,98,95,1],[99,9,99,10,0],[101,9,101,26,1],[102,5,102,6,1],[105,5,105,6,1],[106,9,106,51,1],[108,9,108,35,1],[109,5,109,6,1],[112,5,112,6,1],[113,9,113,92,1],[114,13,114,99,0],[116,9,116,86,1],[117,13,117,96,0],[119,9,119,44,1],[121,9,121,100,1],[122,9,122,10,1],[123,13,123,102,1],[124,13,124,42,1],[125,9,125,10,1],[127,9,127,44,1],[128,9,128,54,1],[129,9,129,52,1],[130,9,130,52,1],[131,9,131,46,1],[132,9,132,64,1],[134,9,134,34,1],[135,5,135,6,1],[138,5,138,6,1],[139,9,139,62,1],[140,13,140,57,1],[142,13,142,60,1],[143,5,143,6,1],[146,5,146,6,1],[147,9,147,73,1],[149,9,149,44,1],[151,9,151,63,1],[153,9,153,34,1],[154,5,154,6,1],[157,5,157,6,1],[158,9,158,73,1],[160,9,160,44,1],[162,9,162,66,1],[164,9,164,34,1],[165,5,165,6,1],[168,5,168,6,1],[169,9,169,82,1],[171,9,171,44,1],[173,9,173,45,1],[175,9,175,34,1],[176,5,176,6,1],[179,5,179,6,1],[180,9,180,82,1],[182,9,182,44,1],[184,9,184,48,1],[186,9,186,34,1],[187,5,187,6,1]]);
    </script>
  </body>
</html>