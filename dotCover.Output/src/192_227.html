<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/src/ConstrutoraViverSA.Application/Mappers/ObraParaObraDto.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using AutoMapper;
using ConstrutoraViverSA.Application.Interfaces;
using ConstrutoraViverSA.Domain;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Enums;

namespace ConstrutoraViverSA.Application.Mappers;

public class ObraParaObraDto : IObraParaObraDto
{
    private readonly IMapper _mapper;

    public ObraParaObraDto(IMapper mapper)
    {
        _mapper = mapper;
    }

    public ObraDto Mapear(Obra obra)
    {
        var dto = _mapper.Map&lt;ObraDto&gt;(obra);

        if (obra.Funcionarios != null &amp;&amp; obra.Funcionarios.Count &gt; 0)
        {
            foreach (var funcionario in obra.Funcionarios!)
            {
                dto.Funcionarios!.Add(funcionario.Id);
            } 
        }

        if (obra.ObraMateriais != null &amp;&amp; obra.ObraMateriais.Count &gt; 0)
        {
            foreach (var materialId in obra.ObraMateriais!.Select(x =&gt; x.MaterialId).Distinct())
            {
                int entrada = obra.ObraMateriais
                    .Where(x =&gt; x.MaterialId == materialId &amp;&amp; x.Operacao == EntradaSaidaEnum.Entrada)
                    .Sum(x =&gt; x.Quantidade);

                int saida = obra.ObraMateriais
                    .Where(x =&gt; x.MaterialId == materialId &amp;&amp; x.Operacao == EntradaSaidaEnum.Saida)
                    .Sum(x =&gt; x.Quantidade);
                    
                var saldoMateriasObra = entrada - saida;

                dto.Materiais!.Add(materialId, saldoMateriasObra);
            }
        }

        return dto;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,5,14,43,1],[15,5,15,6,1],[16,9,16,26,1],[17,5,17,6,1],[20,5,20,6,1],[21,9,21,46,1],[23,9,23,70,1],[24,9,24,10,1],[25,13,25,20,1],[25,22,25,37,1],[25,38,25,40,1],[25,41,25,59,1],[26,13,26,14,1],[27,17,27,55,1],[28,13,28,14,1],[29,9,29,10,1],[31,9,31,72,1],[32,9,32,10,1],[33,13,33,20,1],[33,22,33,36,1],[33,37,33,39,1],[33,40,33,72,1],[33,72,33,84,1],[33,84,33,96,1],[34,13,34,14,1],[35,17,36,33,1],[36,33,36,101,1],[36,101,37,31,1],[37,31,37,43,1],[37,43,37,45,1],[39,17,40,33,1],[40,33,40,99,1],[40,99,41,31,1],[41,31,41,43,0],[41,43,41,45,1],[43,17,43,57,1],[45,17,45,67,1],[46,13,46,14,1],[47,9,47,10,1],[49,9,49,20,1],[50,5,50,6,1]]);
    </script>
  </body>
</html>