<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/tests/ConstrutoraViverSA.Api.Tests/Controllers/MaterialControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using AutoFixture;
using AutoMapper;
using ConstrutoraViverSA.Api.Controllers;
using ConstrutoraViverSA.Api.Controllers.Requests;
using ConstrutoraViverSA.Application.Interfaces;
using ConstrutoraViverSA.Domain;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Enums;
using ConstrutoraViverSA.Domain.Exceptions;
using FluentAssertions;
using Moq;
using Xunit;

namespace ConstrutoraViverSA.Api.Tests.Controllers;

public class MaterialControllerTests
{
    private readonly Mock&lt;IMaterialService&gt; _materialServiceMock;
    private readonly Mock&lt;IMapper&gt; _mapperMock;
    private readonly MaterialController _controller;
    private readonly Fixture _fixture = new Fixture();

    public MaterialControllerTests()
    {
        _materialServiceMock = new Mock&lt;IMaterialService&gt;();
        _mapperMock = new Mock&lt;IMapper&gt;();
        _controller = new MaterialController(_materialServiceMock.Object, _mapperMock.Object);
    }

    [Fact]
    public void CadastrarMaterial_ComDadosValidos_DeveRealizarOperacao()
    {
        var request = _fixture.Create&lt;MaterialRequest&gt;();
        var dto = _fixture.Create&lt;MaterialDto&gt;();

        _mapperMock.Setup(x =&gt; x.Map&lt;MaterialDto&gt;(It.Is&lt;MaterialRequest&gt;(x =&gt; x == request))).Returns(dto);
        _materialServiceMock.Setup(x =&gt; x.Adicionar(It.Is&lt;MaterialDto&gt;(x =&gt; x == dto)));

        var resultado = _controller.CadastrarMaterial(request);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _materialServiceMock.Verify(x =&gt; x.Adicionar(It.Is&lt;MaterialDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;MaterialDto&gt;(It.Is&lt;MaterialRequest&gt;(x =&gt; x == request)), Times.Once);
    }

    [Fact]
    public void CadastrarMaterial_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var request = _fixture.Build&lt;MaterialRequest&gt;()
            .Without(x =&gt; x.Nome)
            .Create();

        var resultado = () =&gt; _controller.CadastrarMaterial(request);

        resultado.Should().Throw&lt;ErroValidacaoException&gt;();
    }

    [Fact]
    public void BuscarMaterial_ComDadosValidos_DeveRealizarOperacao()
    {
        var materialId = 1;
        var material = _fixture.Create&lt;MaterialDto&gt;();
        _materialServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == materialId))).Returns(material);

        var resultado = _controller.BuscarMaterial(materialId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.First().Should().BeOfType&lt;MaterialDto&gt;();
        resultado.Dados.First().Should().BeEquivalentTo(material);
        _materialServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == materialId)), Times.Once);
    }

    [Fact]
    public void BuscarMaterial_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var materialId = 1;
        _materialServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == materialId)))
            .Throws(new NaoEncontradoException(&quot;Material n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.BuscarMaterial(materialId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _materialServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == materialId)), Times.Once);
    }

    [Fact]
    public void BuscarMateriais_ComDadosValidos_DeveRealizarOperacao()
    {
        var listaMateriais = _fixture.CreateMany&lt;MaterialDto&gt;().ToList();
        _materialServiceMock.Setup(x =&gt; x.BuscarTodos())
            .Returns(listaMateriais);

        var resultado = _controller.BuscarMateriais();

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.Count.Should().Be(listaMateriais.Count);
        resultado.Dados.ForEach(x =&gt; x.Should().BeOfType&lt;MaterialDto&gt;());
        for (var i = 0; i &lt; listaMateriais.Count; i++)
        {
            resultado.Dados[i].Should().BeEquivalentTo(listaMateriais[i]);
        }

        _materialServiceMock.Verify(x =&gt; x.BuscarTodos(), Times.Once);
    }

    [Fact]
    public void EditarMaterial_ComDadosValidos_DeveRealizarOperacao()
    {
        var materialId = 1;
        var request = _fixture.Build&lt;EditarMaterialRequest&gt;()
            .Create();
        var dto = _fixture.Build&lt;EditarMaterialDto&gt;()
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;EditarMaterialDto&gt;(It.Is&lt;EditarMaterialRequest&gt;(x =&gt; x == request))).Returns(dto);
        _materialServiceMock.Setup(x =&gt;
            x.Editar(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EditarMaterialDto&gt;(x =&gt; x == dto)));

        var resultado= _controller.EditarMaterial(request, materialId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _materialServiceMock.Verify(
            X =&gt; X.Editar(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EditarMaterialDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;EditarMaterialDto&gt;(It.Is&lt;EditarMaterialRequest&gt;(x =&gt; x == request)), Times.Once);
    }

    [Fact]
    public void EditarMaterial_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var materialId = 1;
        var request = _fixture.Build&lt;EditarMaterialRequest&gt;()
            .Create();
        _materialServiceMock.Setup(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == materialId), It.IsAny&lt;EditarMaterialDto&gt;()))
            .Throws(new NaoEncontradoException(&quot;Material n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.EditarMaterial(request, materialId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _materialServiceMock.Verify(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == materialId), It.IsAny&lt;EditarMaterialDto&gt;()),
            Times.Once);
    }

    [Fact]
    public void ExcluirMaterial_ComDadosValidos_DeveRealizarOperacao()
    {
        var materialId = 1;
        _materialServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == materialId)));

        var resultado = _controller.ExcluirMaterial(materialId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _materialServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == materialId)), Times.Once);
    }

    [Fact]
    public void ExcluirMaterial_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var materialId = 1;
        _materialServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == materialId)))
            .Throws(new NaoEncontradoException(&quot;Material n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.ExcluirMaterial(materialId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _materialServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == materialId)), Times.Once);
    }

    [Fact]
    public void MovimentarEstoque_ComDadosValidos_DeveRealizarOperacao()
    {
        var materialId = 1;
        var quantidade = 1;
        var request = _fixture.Build&lt;EntradaSaidaMaterialRequest&gt;()
            .With(x =&gt; x.Operacao, EntradaSaidaEnum.Entrada)
            .With(x =&gt; x.Quantidade, quantidade)
            .Create();
        var dto = _fixture.Build&lt;EntradaSaidaMaterialDto&gt;()
            .With(x =&gt; x.Operacao, EntradaSaidaEnum.Entrada)
            .With(x =&gt; x.Quantidade, quantidade)
            .Create();
        
        _mapperMock.Setup(x =&gt; x.Map&lt;EntradaSaidaMaterialDto&gt;(It.Is&lt;EntradaSaidaMaterialRequest&gt;(x =&gt; x == request))).Returns(dto);
        _materialServiceMock.Setup(x =&gt; x.MovimentarEstoque(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EntradaSaidaMaterialDto&gt;(x =&gt; x == dto)));
        
        var resultado = _controller.MovimentarEstoque(request, materialId);
        
        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _materialServiceMock.Verify(X =&gt; X.MovimentarEstoque(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EntradaSaidaMaterialDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;EntradaSaidaMaterialDto&gt;(It.Is&lt;EntradaSaidaMaterialRequest&gt;(x =&gt; x == request)), Times.Once);
    }

    [Fact]
    public void MovimentarEstoque_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var materialId = 1;
        var quantidade = 1;
        var request = _fixture.Build&lt;EntradaSaidaMaterialRequest&gt;()
            .With(x =&gt; x.Operacao, EntradaSaidaEnum.Entrada)
            .With(x =&gt; x.Quantidade, quantidade)
            .Create();
        var dto = _fixture.Build&lt;EntradaSaidaMaterialDto&gt;()
            .With(x =&gt; x.Operacao, EntradaSaidaEnum.Entrada)
            .With(x =&gt; x.Quantidade, quantidade)
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;EntradaSaidaMaterialDto&gt;(It.Is&lt;EntradaSaidaMaterialRequest&gt;(x =&gt; x == request))).Returns(dto);
        _materialServiceMock.Setup(x =&gt; x.MovimentarEstoque(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EntradaSaidaMaterialDto&gt;(x =&gt; x == dto)))
            .Throws(new NaoEncontradoException(&quot;Material n&#227;o encontrado&quot;));
        
        var resultado = () =&gt; _controller.MovimentarEstoque(request, materialId);
        
        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _materialServiceMock.Verify(x =&gt; x.MovimentarEstoque(It.Is&lt;long&gt;(x =&gt; x == materialId), It.Is&lt;EntradaSaidaMaterialDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;EntradaSaidaMaterialDto&gt;(It.Is&lt;EntradaSaidaMaterialRequest&gt;(x =&gt; x == request)), Times.Once);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,5,23,55,1],[25,5,25,37,1],[26,5,26,6,1],[27,9,27,61,1],[28,9,28,43,1],[29,9,29,95,1],[30,5,30,6,1],[34,5,34,6,1],[35,9,35,58,1],[36,9,36,50,1],[38,9,38,108,1],[39,9,39,89,1],[41,9,41,64,1],[43,9,43,45,1],[44,9,44,43,1],[45,9,45,47,1],[46,9,46,102,1],[47,9,47,108,1],[48,5,48,6,1],[52,5,52,6,1],[53,9,55,23,1],[57,9,57,31,1],[57,31,57,69,1],[57,69,57,70,1],[59,9,59,60,1],[60,5,60,6,1],[64,5,64,6,1],[65,9,65,28,1],[66,9,66,55,1],[67,9,67,109,1],[69,9,69,64,1],[71,9,71,45,1],[72,9,72,47,1],[73,9,73,46,1],[74,9,74,66,1],[75,9,75,67,1],[76,9,76,104,1],[77,5,77,6,1],[81,5,81,6,1],[82,9,82,28,1],[83,9,84,76,1],[86,9,86,31,1],[86,31,86,69,1],[86,69,86,70,1],[88,9,88,60,1],[89,9,89,104,1],[90,5,90,6,1],[94,5,94,6,1],[95,9,95,74,1],[96,9,97,38,1],[99,9,99,55,1],[101,9,101,45,1],[102,9,102,47,1],[103,9,103,46,1],[104,9,104,65,1],[105,9,105,38,1],[105,38,105,72,1],[105,72,105,74,1],[106,14,106,23,1],[106,25,106,49,1],[106,51,106,54,1],[107,9,107,10,1],[108,13,108,75,1],[109,9,109,10,1],[111,9,111,71,1],[112,5,112,6,1],[116,5,116,6,1],[117,9,117,28,1],[118,9,119,23,1],[120,9,121,23,1],[122,9,122,120,1],[123,9,124,99,1],[126,9,126,72,1],[128,9,128,45,1],[129,9,129,43,1],[130,9,130,47,1],[131,9,132,116,1],[133,9,133,120,1],[134,5,134,6,1],[138,5,138,6,1],[139,9,139,28,1],[140,9,141,23,1],[142,9,143,76,1],[145,9,145,31,1],[145,31,145,78,1],[145,78,145,79,1],[147,9,147,60,1],[148,9,149,25,1],[150,5,150,6,1],[154,5,154,6,1],[155,9,155,28,1],[156,9,156,87,1],[158,9,158,65,1],[160,9,160,45,1],[161,9,161,43,1],[162,9,162,47,1],[163,9,163,100,1],[164,5,164,6,1],[168,5,168,6,1],[169,9,169,28,1],[170,9,171,76,1],[173,9,173,31,1],[173,31,173,70,1],[173,70,173,71,1],[175,9,175,60,1],[176,9,176,100,1],[177,5,177,6,1],[181,5,181,6,1],[182,9,182,28,1],[183,9,183,28,1],[184,9,187,23,1],[188,9,191,23,1],[193,9,193,132,1],[194,9,194,144,1],[196,9,196,76,1],[198,9,198,45,1],[199,9,199,43,1],[200,9,200,47,1],[201,9,201,157,1],[202,9,202,132,1],[203,5,203,6,1],[207,5,207,6,1],[208,9,208,28,1],[209,9,209,28,1],[210,9,213,23,1],[214,9,217,23,1],[218,9,218,132,1],[219,9,220,76,1],[222,9,222,31,1],[222,31,222,81,1],[222,81,222,82,1],[224,9,224,60,1],[225,9,225,157,1],[226,9,226,132,1],[227,5,227,6,1]]);
    </script>
  </body>
</html>