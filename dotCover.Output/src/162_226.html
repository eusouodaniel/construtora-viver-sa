<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/src/ConstrutoraViverSA.Domain/Material.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ConstrutoraViverSA.Domain.Enums;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text;
using ConstrutoraViverSA.Domain.Exceptions;

namespace ConstrutoraViverSA.Domain;

public sealed class Material
{
    public long Id { get; }
    public string Nome { get; private set; }
    public string Descricao { get; private set; }
    public TipoMaterialEnum Tipo { get; private set; }
    public double Valor { get; private set; }
    public int Quantidade { get; private set; }
    public ICollection&lt;Estoque&gt; Estoque { get; } = new Collection&lt;Estoque&gt;();
    public ICollection&lt;ObraMaterial&gt; ObraMateriais { get; } = new Collection&lt;ObraMaterial&gt;();

    [ExcludeFromCodeCoverage]
    public Material()
    {
    }

    public Material(string nome, string descricao, TipoMaterialEnum? tipo, double? valor, int? quantidade)
    {
        var erros = new StringBuilder();

        if (string.IsNullOrWhiteSpace(nome))
            erros.Append(&quot;Nome inv&#225;lido.&quot;);

        if (string.IsNullOrWhiteSpace(descricao))
            erros.Append(&quot;Descri&#231;&#227;o inv&#225;lida.&quot;);

        if (tipo is null)
            erros.Append(&quot;Tipo inv&#225;lido.&quot;);

        if (valor is null or 0)
            erros.Append(&quot;Valor inv&#225;lido.&quot;);

        if (quantidade is null or &lt; 0)
            erros.Append(&quot;Quantidade inv&#225;lida.&quot;);

        if (erros.Length &gt; 0)
            throw new MaterialInvalidoException(erros.ToString());

        if (quantidade &gt; 0)
        {
            Estoque.Add(new Estoque(this, EntradaSaidaEnum.Entrada, quantidade.Value));
        }

        Quantidade = quantidade!.Value;
        Nome = nome;
        Descricao = descricao;
        Tipo = tipo!.Value;
        Valor = valor!.Value;
    }

    public void SetNome(string nome)
    {
        if (string.IsNullOrWhiteSpace(nome))
            return;

        Nome = nome;
    }

    public void SetDescricao(string descricao)
    {
        if (string.IsNullOrWhiteSpace(descricao))
            return;

        Descricao = descricao;
    }

    public void SetTipo(TipoMaterialEnum? tipo)
    {
        if (tipo is null)
            return;

        Tipo = tipo.Value;
    }

    public void SetValor(double? valor)
    {
        if (valor is null or 0)
            return;

        Valor = valor.Value;
    }

    public void MovimentarEstoque(EntradaSaidaEnum? operacao, int? quantidade)
    {
        if (operacao is null)
            throw new OperacaoInvalidaException(&quot;Opera&#231;&#227;o Inv&#225;lida&quot;);

        if (quantidade is null or &lt;= 0)
            throw new OperacaoInvalidaException(&quot;Quantidade Inv&#225;lida&quot;);
        
        var entrada = Estoque.Where(x =&gt; x.Operacao == EntradaSaidaEnum.Entrada).Sum(x =&gt; x.Quantidade);
        var saida = Estoque.Where(x =&gt; x.Operacao == EntradaSaidaEnum.Saida).Sum(x =&gt; x.Quantidade);

        var saldoDeMateriais = entrada - saida;
        
        if ((operacao == EntradaSaidaEnum.Saida) &amp;&amp; saldoDeMateriais &lt; quantidade)
            throw new OperacaoInvalidaException($&quot;Solicitou-se a baixa de {quantidade} itens do estoque, no entanto o material {this.Nome} possui apenas {saldoDeMateriais} itens em estoque&quot;);

        Estoque.Add(new Estoque(this, operacao, quantidade));

        Quantidade = (operacao is EntradaSaidaEnum.Entrada) ? saldoDeMateriais + quantidade!.Value : saldoDeMateriais - quantidade!.Value;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,22,13,26,1],[14,26,14,30,1],[14,31,14,43,1],[15,31,15,35,1],[15,36,15,48,1],[16,36,16,40,1],[16,41,16,53,1],[17,27,17,31,1],[17,32,17,44,1],[18,29,18,33,1],[18,34,18,46,1],[19,43,19,47,1],[19,52,19,77,1],[19,52,19,77,1],[20,54,20,58,1],[20,63,20,93,1],[20,63,20,93,1],[23,5,23,22,1],[24,5,24,6,1],[25,5,25,6,1],[27,5,27,107,1],[28,5,28,6,1],[29,9,29,41,1],[31,9,31,45,1],[32,13,32,44,1],[34,9,34,50,1],[35,13,35,49,1],[37,9,37,26,1],[38,13,38,44,1],[40,9,40,32,1],[41,13,41,45,1],[43,9,43,39,1],[44,13,44,50,1],[46,9,46,30,1],[47,13,47,67,1],[49,9,49,28,1],[50,9,50,10,1],[51,13,51,88,1],[52,9,52,10,1],[54,9,54,40,1],[55,9,55,21,1],[56,9,56,31,1],[57,9,57,28,1],[58,9,58,30,1],[59,5,59,6,1],[62,5,62,6,1],[63,9,63,45,1],[64,13,64,20,1],[66,9,66,21,1],[67,5,67,6,1],[70,5,70,6,1],[71,9,71,50,1],[72,13,72,20,1],[74,9,74,31,1],[75,5,75,6,1],[78,5,78,6,1],[79,9,79,26,1],[80,13,80,20,1],[82,9,82,27,1],[83,5,83,6,1],[86,5,86,6,1],[87,9,87,32,1],[88,13,88,20,1],[90,9,90,29,1],[91,5,91,6,1],[94,5,94,6,1],[95,9,95,30,1],[96,13,96,70,1],[98,9,98,40,1],[99,13,99,72,1],[101,9,101,42,1],[101,42,101,80,1],[101,80,101,91,1],[101,91,101,103,1],[101,103,101,105,1],[102,9,102,40,1],[102,40,102,76,1],[102,76,102,87,1],[102,87,102,99,1],[102,99,102,101,1],[104,9,104,48,1],[106,9,106,83,1],[107,13,107,192,1],[109,9,109,62,1],[111,9,111,139,1],[112,5,112,6,1]]);
    </script>
  </body>
</html>