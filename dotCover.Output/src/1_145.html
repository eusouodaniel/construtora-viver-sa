<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/tests/ConstrutoraViverSA.Api.Tests/Controllers/FuncionarioControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using AutoFixture;
using AutoMapper;
using ConstrutoraViverSA.Api.Controllers;
using ConstrutoraViverSA.Api.Controllers.Requests;
using ConstrutoraViverSA.Application.Interfaces;
using ConstrutoraViverSA.Domain.Dtos;
using ConstrutoraViverSA.Domain.Exceptions;
using FluentAssertions;
using Moq;
using Xunit;

namespace ConstrutoraViverSA.Api.Tests.Controllers;

public class FuncionarioControllerTests
{
    private readonly Mock&lt;IFuncionarioService&gt; _funcionarioServiceMock;
    private readonly Mock&lt;IMapper&gt; _mapperMock;
    private readonly FuncionarioController _controller;
    private readonly Fixture _fixture = new Fixture();
    private const string CPF_VALIDO = &quot;14533067573&quot;;
    private const string CPF_INVALIDO = &quot;14536067573&quot;;
    private const string EMAIL_VALIDO = &quot;email@email&quot;;
    private const string EMAIL_INVALIDO = &quot;email@&quot;;

    public FuncionarioControllerTests()
    {
        _funcionarioServiceMock = new Mock&lt;IFuncionarioService&gt;();
        _mapperMock = new Mock&lt;IMapper&gt;();
        _controller = new FuncionarioController(_funcionarioServiceMock.Object, _mapperMock.Object);
    }

    [Fact]
    public void CadastrarFuncionario_ComDadosValidos_DeveRealizarOperacao()
    {
        var request = _fixture.Build&lt;FuncionarioRequest&gt;()
            .With(x =&gt; x.Cpf, CPF_VALIDO)
            .With(x =&gt; x.Email, EMAIL_VALIDO)
            .Create();
        var dto = _fixture.Build&lt;FuncionarioDto&gt;()
            .With(x =&gt; x.Cpf, CPF_VALIDO)
            .With(x =&gt; x.Email, EMAIL_VALIDO)
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;FuncionarioDto&gt;(It.Is&lt;FuncionarioRequest&gt;(x =&gt; x == request))).Returns(dto);
        _funcionarioServiceMock.Setup(x =&gt; x.Adicionar(It.Is&lt;FuncionarioDto&gt;(x =&gt; x == dto)));

        var resultado = _controller.CadastrarFuncionario(request);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _funcionarioServiceMock.Verify(X =&gt; X.Adicionar(It.Is&lt;FuncionarioDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;FuncionarioDto&gt;(It.Is&lt;FuncionarioRequest&gt;(x =&gt; x == request)), Times.Once);
    }
    
    [Fact]
    public void CadastrarFuncionario_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var request = _fixture.Build&lt;FuncionarioRequest&gt;()
            .With(x =&gt; x.Cpf, CPF_INVALIDO)
            .With(x =&gt; x.Email, EMAIL_INVALIDO)
            .Create();
     
        var resultado = () =&gt; _controller.CadastrarFuncionario(request);
        
        resultado.Should().Throw&lt;ErroValidacaoException&gt;();
       }

    [Fact]
    public void BuscarFuncionario_ComDadosValidos_DeveRealizarOperacao()
    {
        var funcionarioId = 1;
        var funcionario = _fixture.Create&lt;FuncionarioDto&gt;();
        _funcionarioServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == funcionarioId))).Returns(funcionario);

        var resultado = _controller.BuscarFuncionario(funcionarioId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.First().Should().BeOfType&lt;FuncionarioDto&gt;();
        resultado.Dados.First().Should().BeEquivalentTo(funcionario);
        _funcionarioServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)), Times.Once);
    }
    
    [Fact]
    public void BuscarFuncionario_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var funcionarioId = 1;
        _funcionarioServiceMock.Setup(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)))
            .Throws(new NaoEncontradoException(&quot;Funcionario n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.BuscarFuncionario(funcionarioId);

        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _funcionarioServiceMock.Verify(x =&gt; x.BuscarPorId(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)), Times.Once);
    }

    [Fact]
    public void BuscarFuncionarios_ComDadosValidos_DeveRealizarOperacao()
    {
        var listaFuncionarios = _fixture.CreateMany&lt;FuncionarioDto&gt;().ToList();
        _funcionarioServiceMock.Setup(x =&gt; x.BuscarTodos())
            .Returns(listaFuncionarios);

        var resultado = _controller.BuscarFuncionarios();

        resultado.Sucesso.Should().BeTrue();
        resultado.Mensagens.Should().BeNull();
        resultado.Dados.Should().NotBeNull();
        resultado.Dados.Count.Should().Be(listaFuncionarios.Count);
        resultado.Dados.ForEach(x =&gt; x.Should().BeOfType&lt;FuncionarioDto&gt;());
        for (var i =0; i&lt; listaFuncionarios.Count; i++)
        {
            resultado.Dados[i].Should().BeEquivalentTo(listaFuncionarios[i]);
        }
        _funcionarioServiceMock.Verify(x =&gt; x.BuscarTodos(), Times.Once);
    }

    [Fact]
    public void EditarFuncionario_ComDadosValidos_DeveRealizarOperacao()
    {
        var funcionarioId = 1;
        var request = _fixture.Build&lt;FuncionarioRequest&gt;()
            .With(x =&gt; x.Cpf, CPF_VALIDO)
            .With(x =&gt; x.Email, EMAIL_VALIDO)
            .Create();
        var dto = _fixture.Build&lt;FuncionarioDto&gt;()
            .With(x =&gt; x.Cpf, CPF_VALIDO)
            .With(x =&gt; x.Email, EMAIL_VALIDO)
            .Create();
        _mapperMock.Setup(x =&gt; x.Map&lt;FuncionarioDto&gt;(It.Is&lt;FuncionarioRequest&gt;(x =&gt; x == request))).Returns(dto);
        _funcionarioServiceMock.Setup(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == funcionarioId),It.Is&lt;FuncionarioDto&gt;(x =&gt; x == dto)));

        var resultado = _controller.EditarFuncionario(request, funcionarioId);

        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _funcionarioServiceMock.Verify(X =&gt; X.Editar(It.Is&lt;long&gt;(x =&gt; x == funcionarioId),It.Is&lt;FuncionarioDto&gt;(x =&gt; x == dto)), Times.Once);
        _mapperMock.Verify(x =&gt; x.Map&lt;FuncionarioDto&gt;(It.Is&lt;FuncionarioRequest&gt;(x =&gt; x == request)), Times.Once);
    }

    [Fact]
    public void EditarFuncionario_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var funcionarioId = 1;
        var request = _fixture.Build&lt;FuncionarioRequest&gt;()
            .With(x =&gt; x.Cpf, CPF_VALIDO)
            .With(x =&gt; x.Email, EMAIL_VALIDO)
            .Create();
        _funcionarioServiceMock.Setup(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == funcionarioId), It.IsAny&lt;FuncionarioDto&gt;()))
            .Throws(new NaoEncontradoException(&quot;Funcionario n&#227;o encontrado&quot;));
        
        var resultado = () =&gt; _controller.EditarFuncionario(request, funcionarioId);
        
        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _funcionarioServiceMock.Verify(x =&gt; x.Editar(It.Is&lt;long&gt;(x =&gt; x == funcionarioId), It.IsAny&lt;FuncionarioDto&gt;()), Times.Once);
    }

    [Fact]
    public void ExcluirFuncionario_ComDadosValidos_DeveRealizarOperacao()
    {
        var funcionarioId = 1;
        _funcionarioServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)));

        var resultado = _controller.ExcluirFuncionario(funcionarioId);
        
        resultado.Sucesso.Should().BeTrue();
        resultado.Dados.Should().BeNull();
        resultado.Mensagens.Should().BeNull();
        _funcionarioServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)), Times.Once);
    }
    
    [Fact]
    public void ExcluirFuncionario_ComDadosInvalidos_NaoDeveRealizarOperacao()
    {
        var funcionarioId = 1;
        _funcionarioServiceMock.Setup(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)))
            .Throws(new NaoEncontradoException(&quot;Funcionario n&#227;o encontrado&quot;));

        var resultado = () =&gt; _controller.ExcluirFuncionario(funcionarioId);
        
        resultado.Should().Throw&lt;NaoEncontradoException&gt;();
        _funcionarioServiceMock.Verify(x =&gt; x.Excluir(It.Is&lt;long&gt;(x =&gt; x == funcionarioId)), Times.Once);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,5,20,55,1],[26,5,26,40,1],[27,5,27,6,1],[28,9,28,67,1],[29,9,29,43,1],[30,9,30,101,1],[31,5,31,6,1],[35,5,35,6,1],[36,9,39,23,1],[40,9,43,23,1],[44,9,44,114,1],[45,9,45,95,1],[47,9,47,67,1],[49,9,49,45,1],[50,9,50,43,1],[51,9,51,47,1],[52,9,52,108,1],[53,9,53,114,1],[54,5,54,6,1],[58,5,58,6,1],[59,9,62,23,1],[64,9,64,31,1],[64,31,64,72,1],[64,72,64,73,1],[66,9,66,60,1],[67,8,67,9,1],[71,5,71,6,1],[72,9,72,31,1],[73,9,73,61,1],[74,9,74,118,1],[76,9,76,70,1],[78,9,78,45,1],[79,9,79,47,1],[80,9,80,46,1],[81,9,81,69,1],[82,9,82,70,1],[83,9,83,110,1],[84,5,84,6,1],[88,5,88,6,1],[89,9,89,31,1],[90,9,91,79,1],[93,9,93,31,1],[93,31,93,75,1],[93,75,93,76,1],[95,9,95,60,1],[96,9,96,110,1],[97,5,97,6,1],[101,5,101,6,1],[102,9,102,80,1],[103,9,104,41,1],[106,9,106,58,1],[108,9,108,45,1],[109,9,109,47,1],[110,9,110,46,1],[111,9,111,68,1],[112,9,112,38,1],[112,38,112,75,1],[112,75,112,77,1],[113,14,113,22,1],[113,24,113,50,1],[113,52,113,55,1],[114,9,114,10,1],[115,13,115,78,1],[116,9,116,10,1],[117,9,117,74,1],[118,5,118,6,1],[122,5,122,6,1],[123,9,123,31,1],[124,9,127,23,1],[128,9,131,23,1],[132,9,132,114,1],[133,9,133,129,1],[135,9,135,79,1],[137,9,137,45,1],[138,9,138,43,1],[139,9,139,47,1],[140,9,140,142,1],[141,9,141,114,1],[142,5,142,6,1],[146,5,146,6,1],[147,9,147,31,1],[148,9,151,23,1],[152,9,153,79,1],[155,9,155,31,1],[155,31,155,84,1],[155,84,155,85,1],[157,9,157,60,1],[158,9,158,133,1],[159,5,159,6,1],[163,5,163,6,1],[164,9,164,31,1],[165,9,165,93,1],[167,9,167,71,1],[169,9,169,45,1],[170,9,170,43,1],[171,9,171,47,1],[172,9,172,106,1],[173,5,173,6,1],[177,5,177,6,1],[178,9,178,31,1],[179,9,180,79,1],[182,9,182,31,1],[182,31,182,76,1],[182,76,182,77,1],[184,9,184,60,1],[185,9,185,106,1],[186,5,186,6,1]]);
    </script>
  </body>
</html>