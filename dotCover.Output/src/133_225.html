<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/vieir4ndo/Workspace/construtora-viver-sa/src/ConstrutoraViverSA.Api/Middlewares/ErrorHandlerExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Diagnostics.CodeAnalysis;
using System.Net;
using ConstrutoraViverSA.Api.Controllers.Responses;
using ConstrutoraViverSA.Domain.Exceptions;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Diagnostics;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;

namespace ConstrutoraViverSA.Api.Middlewares;

[ExcludeFromCodeCoverage]
public static class ErrorHandlerExtensions
{
    public static IApplicationBuilder UseErrorHandler(
        this IApplicationBuilder appBuilder,
        ILoggerFactory loggerFactory)
    {
        return appBuilder.UseExceptionHandler(builder =&gt;
        {
            builder.Run(async context =&gt;
            {
                var exceptionHandlerFeature = context
                    .Features
                    .Get&lt;IExceptionHandlerFeature&gt;();
                var exceptionHandlerPathFeature =
                    context.Features.Get&lt;IExceptionHandlerPathFeature&gt;();

                if (exceptionHandlerFeature != null)
                {
                    var logger = loggerFactory.CreateLogger(&quot;ErrorHandler&quot;);
                    logger.LogError($&quot;Error: {exceptionHandlerFeature.Error}&quot;);

                    if (exceptionHandlerPathFeature?.Error is NaoEncontradoException naoEncontradoException)
                    {
                        var response = new ResponseApi&lt;object&gt;(false, null, naoEncontradoException.Message);

                        context.Response.StatusCode = (int)HttpStatusCode.NotFound;
                        context.Response.ContentType = &quot;application/json&quot;;

                        await context.Response.WriteAsync(JsonConvert.SerializeObject(response));
                    }
                    else if (exceptionHandlerPathFeature?.Error is ErroValidacaoException erroValidacaoException)
                    {
                        var response = new ResponseApi&lt;object&gt;(false, null, erroValidacaoException.Message);

                        context.Response.StatusCode = (int)HttpStatusCode.BadRequest;
                        context.Response.ContentType = &quot;application/json&quot;;

                        await context.Response.WriteAsync(JsonConvert.SerializeObject(response));
                    }
                    else if (exceptionHandlerPathFeature?.Error is OperacaoInvalidaException invalidOperation)
                    {
                        var response = new ResponseApi&lt;object&gt;(false, null, invalidOperation.Message);

                        context.Response.StatusCode = (int)HttpStatusCode.BadRequest;
                        context.Response.ContentType = &quot;application/json&quot;;

                        await context.Response.WriteAsync(JsonConvert.SerializeObject(response));
                    }
                    else
                    {
                        var response = new ResponseApi&lt;object&gt;(false, null,
                            &quot;Houve um problema ao realizar essa opera&#231;&#227;o, por favor tente novamente mais tarde. Se os problemas persistirem, entre em contato com o suporte.&quot;);

                        context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;
                        context.Response.ContentType = &quot;application/json&quot;;

                        await context.Response.WriteAsync(JsonConvert.SerializeObject(response));
                    }
                }
            });
        });
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,5,19,6,0],[20,9,21,9,0],[21,9,21,10,0],[21,10,22,13,0],[22,13,23,13,0],[23,13,23,14,0],[23,14,24,17,0],[24,17,26,54,0],[26,54,27,17,0],[27,17,28,74,0],[28,74,30,17,0],[30,17,30,53,0],[30,53,31,17,0],[31,17,31,18,0],[31,18,32,21,0],[32,21,32,77,0],[32,77,33,21,0],[33,21,33,80,0],[33,80,35,21,0],[35,21,35,109,0],[35,109,36,21,0],[36,21,36,22,0],[36,22,37,25,0],[37,25,37,109,0],[37,109,39,25,0],[39,25,39,84,0],[39,84,40,25,0],[40,25,40,75,0],[40,75,42,25,0],[42,25,42,98,0],[42,98,43,21,0],[43,21,43,22,0],[43,22,44,26,0],[44,26,44,114,0],[44,114,45,21,0],[45,21,45,22,0],[45,22,46,25,0],[46,25,46,109,0],[46,109,48,25,0],[48,25,48,86,0],[48,86,49,25,0],[49,25,49,75,0],[49,75,51,25,0],[51,25,51,98,0],[51,98,52,21,0],[52,21,52,22,0],[52,22,53,26,0],[53,26,53,111,0],[53,111,54,21,0],[54,21,54,22,0],[54,22,55,25,0],[55,25,55,103,0],[55,103,57,25,0],[57,25,57,86,0],[57,86,58,25,0],[58,25,58,75,0],[58,75,60,25,0],[60,25,60,98,0],[60,98,61,21,0],[61,21,61,22,0],[61,22,63,21,0],[63,21,63,22,0],[63,22,64,25,0],[64,25,65,176,0],[65,176,67,25,0],[67,25,67,95,0],[67,95,68,25,0],[68,25,68,75,0],[68,75,70,25,0],[70,25,70,98,0],[70,98,71,21,0],[71,21,71,22,0],[71,22,72,17,0],[72,17,72,18,0],[72,18,73,13,0],[73,13,73,14,0],[73,14,73,16,0],[73,16,74,9,0],[74,9,74,10,0],[74,10,74,12,0],[75,5,75,6,0]]);
    </script>
  </body>
</html>